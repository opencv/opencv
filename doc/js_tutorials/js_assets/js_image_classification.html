<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Image classification example</title>
    <link href="js_example_style.css" rel="stylesheet" type="text/css" />
</head>

<body>
    <h2>Image Classification Example</h2>
    <p>
        &lt;canvas&gt; element named <b>canvasInput</b> and &lt;table&gt; element named <b>result</b> have been prepared.<br>
        Click <b>Try it</b> button to see the result. You can choose any other image.<br>
        You can change the code in the &lt;textarea&gt; to investigate more.
    </p>
    <div>
        <div class="control"><button id="tryIt">Try it</button></div>
        <textarea class="code" rows="25" cols="100" id="codeEditor" spellcheck="false"></textarea>
        <p class="err" id="errorMessage"></p>
    </div>

    <div>
        <table cellpadding="0" cellspacing="0" width="0" border="0">
            <tr>
                <td>
                    <canvas id="canvasInput" width="400" height="400"></canvas>
                </td>
                <td>
                    <p id='status' align="left"></p>
                    <table style="visibility: hidden;" id="result">
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col" width=300>Label</th>
                                <th scope="col">Probability</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th scope="row">1</th>
                                <td id="label0" align="center"></td>
                                <td id="prob0" align="center"></td>
                            </tr>
                            <tr>
                                    <th scope="row">2</th>
                                    <td id="label1" align="center"></td>
                                    <td id="prob1" align="center"></td>
                            </tr>
                            <tr>
                                    <th scope="row">3</th>
                                    <td id="label2" align="center"></td>
                                    <td id="prob2" align="center"></td>
                            </tr>
                        </tbody>
                    </table>
                    <p id='time' align="left"></p>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="caption">
                        canvasInput <input type="file" id="fileInput" name="file" accept="image/*">
                    </div>
                </td>
                <td></td>
            </tr>
        </table>
    </div>

    <script src="utils.js" type="text/javascript"></script>

    <script id="codeSnippet" type="text/code-snippet">
        let labels;
        if(firstRun){
            loadLables();
            firstRun = false;
        }        

        let inputSize = [224,224];
        let mean = [104, 117, 123];
        let std = 1;
        let input = getBlodFromImage(inputSize, mean, std);

        let modelPath = "bvlc_googlenet.caffemodel";
        let modelUrl = "https://raw.githubusercontent.com/akineeic/opencv_model/master/image_classification/caffe/bvlc_googlenet.caffemodel";
        let configPath = "bvlc_googlenet.prototxt";
        let configUrl = "https://raw.githubusercontent.com/akineeic/opencv_model/master/image_classification/caffe/bvlc_googlenet.prototxt";
        let modelInfo = {
            modelPath: modelPath,
            modelUrl: modelUrl,
            configPath: configPath,
            configUrl: configUrl
        }
        let result = 1;
        loadModel(modelInfo, modelLoaded, () => {
            runModel(modelInfo, input);
        });


        
    </script>

    <script type="text/javascript">
        let utils = new Utils('errorMessage');        

        utils.loadCode('codeSnippet', 'codeEditor');

        let modelLoaded = [];
        let firstRun = true;

        let canvas = document.getElementById('canvasInput');
        let ctx = canvas.getContext('2d');
        let img = new Image();
        img.crossOrigin = 'anonymous';
        img.src = 'panda.jpg';
        img.onload = function() {
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        };

        utils.addFileInputHandler('fileInput', 'canvasInput');

        let tryIt = document.getElementById('tryIt');
        tryIt.addEventListener('click', () => {
            initStatus();
            utils.executeCode('codeEditor');            
        });

        let imgInput = document.getElementById('fileInput');
        imgInput.addEventListener('change', () => {
            initStatus();
            utils.executeCode('codeEditor');
        });

        utils.loadOpenCv(() => {            
            tryIt.removeAttribute('disabled');
        });    

        function loadLables(url){
            document.getElementById('status').innerHTML = 'Loading classification labels';
            let labelsUrl = 'js_image_classification_labels.txt';       
            let request = new XMLHttpRequest();
            request.open('GET', labelsUrl, true);
            request.onload = function(ev) {
                if (request.readyState ===4 ) {
                    if(request.status === 200) {
                        labels = request.response;
                        labels = labels.split('\n')
                    };
                };
            };
            request.send();
        }
        

        function getBlodFromImage(inputSize, mean, std) {
            let mat = cv.imread("canvasInput");
            let matC3 = new cv.Mat(mat.matSize[0],mat.matSize[1],cv.CV_8UC3);
            cv.cvtColor(mat, matC3, cv.COLOR_RGBA2RGB);
            let input = cv.blobFromImage(matC3, std, new cv.Size(inputSize[0], inputSize[1]), 
                                                     new cv.Scalar(mean[0], mean[1], mean[2]));
            return input;
        }


        function loadModel(modelInfo, modelLoaded, callback) {
            if(modelLoaded.indexOf(modelInfo.modelPath) == -1){
                document.getElementById('status').innerHTML = 'Loading model';
                utils.createFileFromUrl(modelInfo.modelPath, modelInfo.modelUrl, () => {
                    modelLoaded.push(modelInfo.modelPath);
                    if(modelInfo.configUrl != null) {
                        utils.createFileFromUrl(modelInfo.configPath, modelInfo.configUrl, () => {                            
                            callback();
                        });
                    }
                });
            } else {
                callback();
            }
        }
        

        function runModel(modelInfo, input) {
            document.getElementById('status').innerHTML = 'Running model';

            let net;
            if(modelInfo.configUrl !== null){
                net = cv.readNet(modelInfo.configPath, modelInfo.modelPath);   
            } else {
                net = cv.readNet(modelInfo.modelPath);
            }
                             
            net.setInput(input);
            let start = performance.now();
            let result =net.forward();
            let end = performance.now();
            let time  = end-start;            

            let classes = getTopClasses(result, labels, 3);            
            updateResult(classes, time);
            net.delete();
            result.delete();
        }


        function getTopClasses(mat, labels, k = 5) {
            let initdata = mat.data32F
            let probs = Array.from(initdata);
            let indexes = probs.map((prob, index) => [prob, index]);
            let sorted = indexes.sort((a, b) => {
            if (a[0] === b[0]) {return 0;}
            return a[0] < b[0] ? -1 : 1;
            });
            sorted.reverse();
            let classes = [];
            for (let i = 0; i < k; ++i) {
            let prob = sorted[i][0];
            let index = sorted[i][1];
            let c = {
                label: labels[index],
                prob: (prob * 100).toFixed(2)
            }
            classes.push(c);
            }
            return classes;
        }

        const updateResult = (classes, time) =>{            
            try{
                classes.forEach((c,i) => {
                    let labelElement = document.getElementById('label'+i);
                    let probElement = document.getElementById('prob'+i);
                    labelElement.innerHTML = c.label;
                    probElement.innerHTML = c.prob + '%';
                });
                let result = document.getElementById('result');
                result.style.visibility = 'visible';
                document.getElementById('status').innerHTML = '';
                document.getElementById('time').innerHTML = `<b>Inference time:</b> ${time.toFixed(2)} ms`;
            } catch(e) {
                console.log(e);
            }
        }

        function initStatus() {
            document.getElementById('status').innerHTML = '';
            document.getElementById('result').style.visibility = 'hidden';
        }


    </script>
    
</body>

</html>